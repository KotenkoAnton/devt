"use strict";
let whats_up;

let set_events = () => {
  let select_button = button => {
    const buttons = [
      "ruler_button",
      "add_button",
      "switch_mode_button",
      "delete_button"
    ];
    $(`#${button}_active_img`).show();
    $(`#${button}_inactive_img`).hide();
    buttons.forEach(btn => {
      if (btn == button) {
        return;
      }
      $(`#${btn}_active_img`).hide();
      $(`#${btn}_inactive_img`).show();
    });
  };

  let activate_all_buttons = () => {
    const buttons = [
      "ruler_button",
      "add_button",
      "switch_mode_button",
      "delete_button"
    ];
    buttons.forEach(btn => {
      $(`#${btn}_active_img`).show();
      $(`#${btn}_inactive_img`).hide();
    });
  };

  $("#add_button").click(() => {
    add_button_click();
  });

  const add_button_click = () => {
    activate_all_buttons();
    whats_up.mouse_event_handler.switch_to("clickable");
    whats_up.mouse_event_handler.switch_clickable_mode_to("main_usage");
    whats_up.dom_elements_handler.open_action_box("add_object");
  }

  $("#ruler_button").click(() => {
    if (whats_up.mouse_event_handler.get_clickable_mode() == "ruler") {
      whats_up.mouse_event_handler.switch_clickable_mode_to("main_usage");
      $("body").css({ cursor: "default" });
      activate_all_buttons();
    } else {
      whats_up.mouse_event_handler.switch_to("clickable");
      whats_up.mouse_event_handler.switch_clickable_mode_to("ruler");
      $("body").css({ cursor: "crosshair" });
      select_button("ruler_button");
    }
  });

  $("#confirm_box_close_button").click(() => {
    $("#confirm_deleting_box").css("display", "none");
  });

  // switch mode

  $("#switch_mode_button").click(() => {
    let mode = whats_up.mouse_event_handler.toggle_mode();
    if (mode == "clickable") {
      activate_all_buttons();
    } else {
      select_button("switch_mode_button");
    }
  });

  //

  $("#delete_button").click(() => {
    if ($("body").css("cursor") == "crosshair") {
      whats_up.mouse_event_handler.switch_to("clickable");
      whats_up.mouse_event_handler.switch_clickable_mode_to("main_usage");
      activate_all_buttons();
      $("body").css({ cursor: "auto" });
    } else {
      whats_up.mouse_event_handler.switch_to("clickable");
      whats_up.mouse_event_handler.switch_clickable_mode_to("deleting");
      select_button("delete_button");
      $("body").css({ cursor: "crosshair" });
    }
  });

  // search

  let timeout;
  $("#search").keyup(() => {
    if ($("#search").val()) {
      $("#search_empty_button").show();
    } else {
      $("#search_empty_button").hide();
    }
    search();
  });

  $("#search").focus(() => {
    if ($("#search").val().length > 2) {
      search();
    }
  });

  $("#search_empty_button").click(() => {
    $("#search").val("");
    $("#search_empty_button").hide();
  });

  let search = () => {
    let filter = $("#search").val();
    if (filter.length < 3) {
      return;
    }
    if (timeout) {
      clearTimeout(timeout);
    }

    timeout = setTimeout(() => {
      whats_up.api_communicator.find_items(filter, data => {
        if (data.search_str != $("#search").val()) {
          return;
        }
        $("#search_box").css("display", "block");
        let html = "";
        data.items.forEach(item => {
          item.name += ` (${item.placeable.ip_address.ip_address})`;
          html += `
            <div data-item-id="${item.id}" data-map-name=${
            item.map.name
          } class="search-row">
              ${item.name.replace(
                new RegExp(data.search_str, "ig"),
                "<span>$&</span>"
              )}
              <svg xmlns="http://www.w3.org/2000/svg">
                <circle cx="5" cy="5" r="5" fill=${
                  item.placeable.ip_address.icmp_available ? "green" : "red"
                }/>
              </svg>
              <hr>
            </div>
          `;
        });
        $("#search_box").html(html);
        $(".search-row").click(event => {
          window.location.href = `${location.origin}/maps?map=${$(
            event.currentTarget
          ).data("map-name")}&focus_item_id=${$(event.currentTarget).data(
            "item-id"
          )}`;
        });
      });
    }, 600);
  };

  window.onclick = event => {
    if (!$(event.target).closest(".search-box,.search-row").length) {
      $("#search_box").css("display", "none");
    }
  };

  //

  // minimize button

  $("#minimize_navbar_btn").click(() => {
    if (!$("body").hasClass("mini-navbar")) {
      $("#head_wrapper").removeClass("width96");
      $("#head_wrapper").addClass("width88");
      $("#topnavbar_wrapper").removeClass("width96");
      $("#topnavbar_wrapper").addClass("width88");
    } else {
      $("#head_wrapper").removeClass("width88");
      $("#head_wrapper").addClass("width96");
      $("#topnavbar_wrapper").removeClass("width88");
      $("#topnavbar_wrapper").addClass("width96");
    }
    $.post({
      url: location.origin + "/custom_settings/change",
      data: { setting: "minimize_navbar" }
    });
  });

  //

  // change view buttons

  $("#list_view_button").click(() => {
    $("#canvas_wrapper").hide();
    $("#devices_list_view_wrapper").show();
    $("#map_view_active").hide();
    $("#map_view_not_active").show();
    $("#list_view_not_active").hide();
    $("#list_view_active").show();
    $("#map_view_button").removeClass("head-button-active");
    $("#list_view_button").addClass("head-button-active");

    whats_up.api_communicator.fetch_devices_for_list_view(
      whats_up.map_name,
      data => {
        let html_for_table_body = "";
        data["devices"].forEach(device => {
          html_for_table_body += `
            <tr>
              <td>
                <span class="list-view-availability-${
                  device.icmp_available ? "green" : "red"
                }">
                  ${device.icmp_available ? "Active" : "Not Active"}
                  <svg xmlns="http://www.w3.org/2000/svg">
                    <circle cx="5" cy="5" r="5" fill=${
                      device.icmp_available ? "green" : "red"
                    }/>
                  </svg>
                </span>
              </td>
              <td>
                <span class="link-span" id="list_view_item_name" data-item-id="${
                  device.item_id
                }">${device.name}</span>
                <i id="list_view_copy_name_button" data-item-id="${
                  device.item_id
                }" class="fa fa-copy"></i>
              </td>
              <td>
                <span class="link-span" id="list_view_item_ip" data-item-id="${
                  device.item_id
                }">${device.ip}</span>
                <i id="list_view_copy_ip_button" data-item-id="${
                  device.item_id
                }" class="fa fa-copy"></i>
              </td>
              <td>${device.type}</td>
              <td>${device.changed_status_at}</td>
            </tr>
          `;
        });
        $("#list_view_table_body").html(html_for_table_body);
        $("#list_view_table_body")
          .promise()
          .done(set_list_view_events());
      }
    );

    const set_list_view_events = () => {
      $("[id=list_view_item_name]").click(event => {
        window.location.href = `${location.origin}/maps?map=${
          whats_up.map_name
        }&focus_item_id=${$(event.target).data("item-id")}`;
      });

      $("[id=list_view_item_ip]").click(event => {
        window.open(`http://${$(event.target).html()}/`, "_blank");
      });

      $("[id=list_view_copy_name_button]").click(event => {
        const target = $(event.target);
        const name_target = $(
          `[id=list_view_item_name][data-item-id=${target.data("item-id")}]`
        );
        whats_up.copy_to_clipboard(name_target.html());
      });

      $("[id=list_view_copy_ip_button]").click(event => {
        const target = $(event.target);
        const ip_target = $(
          `[id=list_view_item_ip][data-item-id=${target.data("item-id")}]`
        );
        whats_up.copy_to_clipboard(ip_target.html());
      });
    };
  });

  $("#map_view_button").click(() => {
    $("#canvas_wrapper").show();
    $("#devices_list_view_wrapper").hide();
    $("#map_view_active").show();
    $("#map_view_not_active").hide();
    $("#list_view_not_active").show();
    $("#list_view_active").hide();
    $("#map_view_button").addClass("head-button-active");
    $("#list_view_button").removeClass("head-button-active");
  });

  //

  // navigation panel

  $("#navigation_add_button").click(() => {
    add_button_click();
  });

  //
};

let init = () => {
  $('[data-toggle="tooltip"]').tooltip();
  let url = new URLSearchParams(window.location.search);
  whats_up = new WhatsUp("canvas");
  let map_name = $("#map_name").html();
  whats_up.load_map(map_name, url.get("focus_item_id"));
  url.delete("focus_item_id");
  window.history.pushState(null, "", `/maps?${url}`);
  set_events();
};

window.onload = () => init();
